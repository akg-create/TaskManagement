<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - TaskFlow</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>Admin Panel</h2>
  <button onclick="logout()">Logout</button>

  <h3>Users</h3>
  <ul id="userList"></ul>

  <!-- View User Info Modal -->
  <div id="userInfoModal" class="modal hidden">
    <div class="modal-content">
      <h3>User Information</h3>
      <p><strong>ID:</strong> <span id="infoUserId"></span></p>
      <p><strong>Username:</strong> <input type="text" id="infoUsername" /></p>
      <p><strong>Email:</strong> <span id="infoEmail"></span></p>
      <p><strong>Status:</strong> <span id="infoStatus"></span></p>
      <button id="saveUserChanges">Save Changes</button>
      <button onclick="closeUserInfoModal()">Close</button>
    </div>
  </div>

  <!-- View Tasks Modal -->
  <div id="userTasksModal" class="modal hidden">
    <div class="modal-content">
      <h3>User's Tasks</h3>
      <ul id="userTaskList"></ul>
      <button onclick="closeTaskModal()">Close</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      collection,
      getDocs,
      getDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    let currentAdminId = null;
    let selectedUserId = null;

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = "login.html";

      const adminDoc = await getDoc(doc(db, "users", user.uid));
      if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
        alert("Access Denied");
        return window.location.href = "login.html";
      }

      currentAdminId = user.uid;
      await loadUsers();
    });

    async function loadUsers() {
      const usersSnap = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      usersSnap.forEach(docSnap => {
        const u = docSnap.data();
        const uid = docSnap.id;

        const li = document.createElement("li");
        li.innerHTML = `
          ${u.username || u.email || "No name"} - <strong>${u.active ? "Active" : "Inactive"}</strong>
          <button class="small-btn" onclick="viewUserInfo('${uid}')">View Info</button>
          <button class="small-btn" onclick="viewUserTasks('${uid}')">View Tasks</button>
          <button class="small-btn" onclick="toggleUserActive('${uid}', ${!u.active})">
            ${u.active ? 'Deactivate' : 'Activate'}
          </button>
          <button class="small-btn" onclick="deleteUser('${uid}')">Delete User</button>
        `;
        userList.appendChild(li);
      });
    }

    window.viewUserInfo = async (uid) => {
      const docSnap = await getDoc(doc(db, "users", uid));
      const user = docSnap.data();

      selectedUserId = uid;
      document.getElementById("infoUserId").textContent = uid;
      document.getElementById("infoUsername").value = user.username || "";
      document.getElementById("infoEmail").textContent = user.email || "";
      document.getElementById("infoStatus").textContent = user.active ? "Active" : "Inactive";

      document.getElementById("userInfoModal").classList.remove("hidden");
    };

    window.closeUserInfoModal = function () {
      document.getElementById("userInfoModal").classList.add("hidden");
    };

    document.getElementById("saveUserChanges").addEventListener("click", async () => {
      const newUsername = document.getElementById("infoUsername").value;
      if (selectedUserId && newUsername) {
        await updateDoc(doc(db, "users", selectedUserId), { username: newUsername });
        alert("User info updated.");
        closeUserInfoModal();
        await loadUsers();
      }
    });

    window.viewUserTasks = async function (uid) {
      const taskList = document.getElementById("userTaskList");
      taskList.innerHTML = "<li>Loading...</li>";
      document.getElementById("userTasksModal").classList.remove("hidden");

      const taskQuery = query(collection(db, "tasks"), where("user_id", "==", uid));
      const taskSnap = await getDocs(taskQuery);
      taskList.innerHTML = "";

      if (taskSnap.empty) {
        taskList.innerHTML = "<li>No tasks found.</li>";
        return;
      }

      taskSnap.forEach(t => {
        const data = t.data();
        const li = document.createElement("li");
        li.textContent = `${data.title} - ${data.status}`;
        taskList.appendChild(li);
      });
    };

    window.closeTaskModal = function () {
      document.getElementById("userTasksModal").classList.add("hidden");
    };

    window.toggleUserActive = async (uid, state) => {
      if (uid === currentAdminId) {
        alert("You cannot deactivate yourself.");
        return;
      }

      await updateDoc(doc(db, "users", uid), { active: state });
      alert("User status updated.");
      await loadUsers();
    };

    window.deleteUser = async (uid) => {
      if (uid === currentAdminId) {
        const usersSnap = await getDocs(collection(db, "users"));
        const otherAdmins = usersSnap.docs.filter(d => d.id !== currentAdminId && d.data().isAdmin);
        if (otherAdmins.length === 0) {
          alert("Cannot delete yourself as the only admin.");
          return;
        }
      }

      if (confirm("Delete this user?")) {
        await deleteDoc(doc(db, "users", uid));
        alert("User deleted.");
        await loadUsers();
      }
    };

    window.logout = async function () {
      await signOut(auth);
      window.location.href = "login.html";
    };
  </script>
</body>
</html>
