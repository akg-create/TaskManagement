<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - TaskFlow</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h2>Admin Panel</h2>
  <button onclick="logout()">Logout</button>

  <h3>Users</h3>
  <ul id="userList"></ul>

  <h3>User's Tasks</h3>
  <ul id="userTaskList"></ul>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import {
      collection,
      getDocs,
      getDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    let currentUserId = null;
    let currentAdminId = null;

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = "login.html";
      currentUserId = user.uid;

      // Verify logged in user is admin
      const currentAdminDoc = await getDoc(doc(db, "users", user.uid));
      if (!currentAdminDoc.exists() || !currentAdminDoc.data().isAdmin) {
        alert("Access Denied");
        return window.location.href = "login.html";
      }

      currentAdminId = user.uid;
      await loadUsers();
      clearUserTasks();
    });

    async function loadUsers() {
      const usersSnap = await getDocs(collection(db, "users"));
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      usersSnap.forEach(async (docSnap) => {
        const u = docSnap.data();
        const uid = docSnap.id;

        // Debug info
        console.log("Checking user:", uid, u);

        const taskSnap = await getDocs(query(collection(db, "tasks"), where("user_id", "==", uid)));
        console.log(`Tasks found for ${uid}:`, taskSnap.size);

        const isActive = taskSnap.size > 0;

        const li = document.createElement("li");
        li.innerHTML = `
          ${u.username || u.email || "No name"} - <strong>${isActive ? "Active" : "Inactive"}</strong><br>
          <button onclick="viewUserTasks('${uid}')">View Tasks</button>
          <button onclick="deleteUser('${uid}')">Delete User</button>
        `;
        userList.appendChild(li);
      });
    }

    async function viewUserTasks(userId) {
      clearUserTasks();
      const userTaskList = document.getElementById("userTaskList");
      userTaskList.innerHTML = `<li>Loading tasks...</li>`;

      const tasksQuery = query(collection(db, "tasks"), where("user_id", "==", userId));
      const tasksSnap = await getDocs(tasksQuery);

      userTaskList.innerHTML = ""; // Clear loading text

      if (tasksSnap.empty) {
        userTaskList.innerHTML = "<li>No tasks found for this user.</li>";
        return;
      }

      tasksSnap.forEach(taskDoc => {
        const t = taskDoc.data();
        const li = document.createElement("li");
        li.textContent = `${t.title} - ${t.status}`;
        userTaskList.appendChild(li);
      });
    }

    async function clearUserTasks() {
      document.getElementById("userTaskList").innerHTML = "";
    }

    window.deleteUser = async (uid) => {
      if (uid === currentAdminId) {
        const usersSnap = await getDocs(collection(db, "users"));
        const otherAdmins = usersSnap.docs.filter(d => d.id !== currentAdminId && d.data().isAdmin);
        if (otherAdmins.length === 0) {
          alert("Cannot delete yourself as the only admin. Assign another admin before deleting.");
          return;
        }
      }

      if (confirm("Delete this user? This action cannot be undone.")) {
        await deleteDoc(doc(db, "users", uid));
        alert("User deleted");
        await loadUsers();
        clearUserTasks();
      }
    };

    window.viewUserTasks = viewUserTasks;
    window.logout = async function () {
      await signOut(auth);
      window.location.href = "login.html";
    };
    
  </script>
</body>
</html>

