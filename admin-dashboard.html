<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - TaskFlow</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>Admin Dashboard</h2>
<button onclick="window.location.href='admin-panel.html'">Back to Admin Panel</button>
<button onclick="logout()">Logout</button>

<section>
  <h3>User Stats</h3>
  <p>Total Users: <span id="totalUsers">0</span></p>
  <p>Active Users: <span id="activeUsers">0</span></p>
  <p>Inactive Users: <span id="inactiveUsers">0</span></p>
</section>

<section>
  <h4>Active Users</h4>
  <ul id="activeUserList"></ul>

  <h4>Inactive Users</h4>
  <ul id="inactiveUserList"></ul>
</section>

<section>
  <h3>Activity Overview</h3>
  <p>Total Tasks: <span id="totalTasks">0</span></p>
  <canvas id="taskCategoryChart" width="400" height="200"></canvas>
</section>

<section>
  <h3>Filter Tasks by Date Range</h3>
  <input type="date" id="startDate">
  <input type="date" id="endDate">
  <button onclick="applyFilters()">Apply Filters</button>
  <p id="filterSummary"></p>
  <ul id="filteredTaskList"></ul>
</section>

<script type="module">
  import { auth, db } from './firebase-config.js';
  import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    collection, getDocs, doc, getDoc,
    query, where
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  let taskData = [];

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";

    const adminDoc = await getDoc(doc(db, "users", user.uid));
    if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
      alert("Access Denied");
      return window.location.href = "login.html";
    }

    await loadStats();
  });

  async function loadStats() {
    const usersSnap = await getDocs(collection(db, "users"));
    const tasksSnap = await getDocs(collection(db, "tasks"));

    let totalUsers = 0;
    let activeUsers = 0;
    let inactiveUsers = 0;

    const activeList = document.getElementById("activeUserList");
    const inactiveList = document.getElementById("inactiveUserList");
    activeList.innerHTML = "";
    inactiveList.innerHTML = "";

    usersSnap.forEach(doc => {
      const user = doc.data();
      totalUsers++;
      const li = document.createElement("li");
      li.textContent = `${user.username || user.email}`;

      if (user.active) {
        activeUsers++;
        activeList.appendChild(li);
      } else {
        inactiveUsers++;
        inactiveList.appendChild(li);
      }
    });

    document.getElementById("totalUsers").textContent = totalUsers;
    document.getElementById("activeUsers").textContent = activeUsers;
    document.getElementById("inactiveUsers").textContent = inactiveUsers;

    taskData = [];
    tasksSnap.forEach(doc => {
      const task = doc.data();
      task.created_at = task.created_at?.toDate?.() || new Date();
      task.title = task.title || "Untitled";
      task.status = task.status || "Unknown";
      taskData.push(task);
    });

    document.getElementById("totalTasks").textContent = taskData.length;
    drawTaskCategoryChart(taskData);
  }

  function drawTaskCategoryChart(data) {
    const categoryCounts = { ToDo: 0, InProgress: 0, Done: 0 };

    data.forEach(task => {
      const status = task.status || "Unknown";
      if (categoryCounts[status] !== undefined) {
        categoryCounts[status]++;
      }
    });

    const ctx = document.getElementById("taskCategoryChart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(categoryCounts),
        datasets: [{
          label: "Task Status Breakdown",
          data: Object.values(categoryCounts),
          backgroundColor: ["#3498db", "#f1c40f", "#2ecc71"]
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  window.applyFilters = () => {
    const start = document.getElementById("startDate").valueAsDate;
    const end = document.getElementById("endDate").valueAsDate;
    const summary = document.getElementById("filterSummary");
    const list = document.getElementById("filteredTaskList");

    if (!start || !end) {
      alert("Please select both start and end dates.");
      return;
    }

    const filteredTasks = taskData.filter(t =>
      t.created_at >= start && t.created_at <= end
    );

    summary.textContent = `Showing ${filteredTasks.length} tasks from ${start.toDateString()} to ${end.toDateString()}`;

    // Show task titles
    list.innerHTML = "";
    filteredTasks.forEach(t => {
      const li = document.createElement("li");
      li.textContent = `${t.title} - ${t.status} (${t.created_at.toLocaleDateString()})`;
      list.appendChild(li);
    });

    drawTaskCategoryChart(filteredTasks);
  };

  window.logout = async function () {
    await signOut(auth);
    window.location.href = "login.html";
  };
</script>
</body>
</html>

