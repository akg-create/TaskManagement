<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - TaskFlow</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>Admin Dashboard</h2>
<button onclick="window.location.href='admin-panel.html'">Back to Admin Panel</button>
<button onclick="logout()">Logout</button>

<section>
  <h3>User Stats</h3>
  <p>Total Users: <span id="totalUsers">0</span></p>
  <p>Currently Active Users: <span id="activeUsers">0</span></p>
  <p>Currently Inactive Users: <span id="inactiveUsers">0</span></p>
  <p>Deactivated Users (by Admin): <span id="deactivatedUserCount">0</span></p>
</section>

<section>
  <h4>Currently Active Users</h4>
  <ul id="activeUserList"></ul>

  <h4>Currently Inactive Users</h4>
  <ul id="inactiveUserList"></ul>

  <h4>Deactivated Users</h4>
  <ul id="deactivatedUserList"></ul>
</section>

<section>
  <h3>Activity Overview</h3>
  <p>Total Tasks: <span id="totalTasks">0</span></p>
  <canvas id="taskCategoryChart" width="400" height="200"></canvas>
</section>

<section>
  <h3>Filter Tasks by Date Range</h3>
  <input type="date" id="startDate">
  <input type="date" id="endDate">
  <button onclick="applyFilters()">Apply Filters</button>
  <p id="filterSummary"></p>
  <ul id="filteredTaskList"></ul>
</section>

<script type="module">
  import { auth, db } from './firebase-config.js';
  import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
  import {
    collection, getDocs, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  let taskData = [];
  let taskChart = null;

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";

    const adminDoc = await getDoc(doc(db, "users", user.uid));
    if (!adminDoc.exists() || !adminDoc.data().isAdmin) {
      alert("Access Denied");
      return window.location.href = "login.html";
    }

    await loadStats();
  });

  async function loadStats() {
    const usersSnap = await getDocs(collection(db, "users"));
    const tasksSnap = await getDocs(collection(db, "tasks"));

    let totalUsers = 0;
    let activeUsers = 0;
    let inactiveUsers = 0;
    let deactivatedUsers = 0;

    const activeList = document.getElementById("activeUserList");
    const inactiveList = document.getElementById("inactiveUserList");
    const deactivatedList = document.getElementById("deactivatedUserList");

    activeList.innerHTML = "";
    inactiveList.innerHTML = "";
    deactivatedList.innerHTML = "";

    const now = new Date();
    const ACTIVE_THRESHOLD_MINUTES = 5;

    usersSnap.forEach(docSnap => {
      const user = docSnap.data();
      const uid = docSnap.id;
      totalUsers++;

      const li = document.createElement("li");
      const displayName = user.username || user.email || uid;
      const lastActive = user.lastActive?.toDate?.();
      const isDeactivated = user.active === false;

      if (isDeactivated) {
        deactivatedUsers++;
        li.textContent = `${displayName} - Deactivated by Admin`;
        deactivatedList.appendChild(li);
        return;
      }

      if (!lastActive) {
        inactiveUsers++;
        li.textContent = `${displayName} - No recent activity`;
        inactiveList.appendChild(li);
        return;
      }

      const minutesAgo = Math.floor((now - lastActive) / 60000);
      const timeString = minutesAgo < 1 ? "just now" : `${minutesAgo} min ago`;

      if (minutesAgo <= ACTIVE_THRESHOLD_MINUTES) {
        activeUsers++;
        li.textContent = `${displayName} - Active (${timeString})`;
        activeList.appendChild(li);
      } else {
        inactiveUsers++;
        li.textContent = `${displayName} - Inactive (${timeString})`;
        inactiveList.appendChild(li);
      }
    });

    document.getElementById("totalUsers").textContent = totalUsers;
    document.getElementById("activeUsers").textContent = activeUsers;
    document.getElementById("inactiveUsers").textContent = inactiveUsers;
    document.getElementById("deactivatedUserCount").textContent = deactivatedUsers;

    // Prepare task data
    taskData = [];
    tasksSnap.forEach(doc => {
      const task = doc.data();
      task.created_at = task.created_at?.toDate?.() || new Date();
      task.title = task.title || "Untitled";
      task.status = task.status || "Unknown";

      // Normalize moderation type
      if (["ToDo", "InProgress", "Done"].includes(task.status)) {
        task.moderation = "approved";
      } else if (task.status === "rejected") {
        task.moderation = "rejected";
      } else {
        task.moderation = "unknown";
      }

      taskData.push(task);
    });

    document.getElementById("totalTasks").textContent = taskData.length;
    drawTaskCategoryChart(taskData);
  }

  function drawTaskCategoryChart(data) {
    const categoryCounts = { ToDo: 0, InProgress: 0, Done: 0, Rejected: 0 };

    data.forEach(task => {
      if (task.moderation === "rejected") {
        categoryCounts.Rejected++;
      } else if (["ToDo", "InProgress", "Done"].includes(task.status)) {
        categoryCounts[task.status]++;
      }
    });

    const ctx = document.getElementById("taskCategoryChart").getContext("2d");

    if (taskChart) taskChart.destroy();

    taskChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(categoryCounts),
        datasets: [{
          label: "Task Status Breakdown",
          data: Object.values(categoryCounts),
          backgroundColor: ["#3498db", "#f1c40f", "#2ecc71", "#e74c3c"]
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  window.applyFilters = () => {
    const start = document.getElementById("startDate").valueAsDate;
    const end = document.getElementById("endDate").valueAsDate;
    const summary = document.getElementById("filterSummary");
    const list = document.getElementById("filteredTaskList");

    if (!start || !end) {
      alert("Please select both start and end dates.");
      return;
    }

    const filteredTasks = taskData.filter(t =>
      t.created_at >= start && t.created_at <= end
    );

    summary.textContent = `Showing ${filteredTasks.length} tasks from ${start.toDateString()} to ${end.toDateString()}`;

    list.innerHTML = "";
    filteredTasks.forEach(t => {
      const li = document.createElement("li");
      li.textContent = `${t.title} - ${t.status} (${t.created_at.toLocaleDateString()})`;
      list.appendChild(li);
    });

    drawTaskCategoryChart(filteredTasks);
  };

  window.logout = async function () {
    await signOut(auth);
    window.location.href = "login.html";
  };
</script>
</body>
</html>
